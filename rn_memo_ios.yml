trigger:
  - master

pool:
  vmImage: "macos-latest"

# name: $(Environment)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "12.16.2"
    displayName: "Install Node"

  - script: npm install
    workingDirectory: RN_memo
    displayName: "Install node dependencies"

  - task: CocoaPods@0
    displayName: "Install CocoaPods dependencies"
    inputs:
      workingDirectory: RN_memo/ios
      forceRepoUpdate: false

  # - task: CmdLine@2
  #   displayName: "Run Unit Tests"
  #   inputs:
  #     script: 'xcodebuild test -workspace ReactNativePipeline.xcworkspace -scheme ReactNativePipeline -destination ''platform=iOS Simulator,name=iPhone 8'' -skip-testing OperationsMobileApplicationUITests | xcpretty --report junit && exit ${PIPESTATUS[0]}'
  #     workingDirectory: '$(Build.SourcesDirectory)/src/ios'

  # - task: PublishTestResults@2
  #   displayName: "Publish Test Results"
  #   inputs:
  #     testResultsFormat: 'JUnit'
  #     testResultsFiles: 'junit.xml'
  #     searchFolder: '$(Build.SourcesDirectory)/src/ios/build/reports/'
  #     failTaskOnFailedTests: true

  - task: InstallAppleCertificate@2
    displayName: "Install Apple Certificate"
    inputs:
      certSecureFile: "$(P12FileName)"
      certPwd: "$(P12Password)"

  - task: InstallAppleProvisioningProfile@1
    displayName: "Install Apple provisioning profile"
    inputs:
      provisioningProfileLocation: "secureFiles"
      provProfileSecureFile: "$(provProfileSecureFileName)"

  - task: ios-bundle-version@1
    displayName: "Set versions"
    inputs:
      sourcePath: "RN_memo/ios/RN_memo/Info.plist"
      versionCodeOption: "buildid"
      versionCode: "$(Build.BuildId)"
      printFile: true

  - task: Xcode@5
    displayName: "Build Mobile Application"
    inputs:
      actions: "build"
      configuration: "Release"
      sdk: "iphoneos"
      xcWorkspacePath: "RN_memo/ios/RN_memo.xcworkspace"
      scheme: "RN_memo"
      packageApp: true
      exportPath: "output/package"
      archivePath: "output/archive"
      signingOption: "manual"
      signingIdentity: "$(APPLE_CERTIFICATE_SIGNING_IDENTITY)"
      provisioningProfileUuid: "$(APPLE_PROV_PROFILE_UUID)"
      useXcpretty: false

  - task: CmdLine@2
    displayName: "Rename build build artifact to include build number"
    inputs:
      script: "mv output/package/RN_memo.ipa output/package/RN_memo$(Build.BuildNumber).ipa"

  - task: PublishBuildArtifacts@1
    displayName: "Publish Build Artifact"
    inputs:
      PathtoPublish: "output/package/RN_memo$(Build.BuildNumber).ipa"
      ArtifactName: "drop"
      publishLocation: "Container"
  # - task: AppCenterDistribute@3
  #   displayName: "Create a release on App Center"
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  #   inputs:
  #     serverEndpoint: "app-center"
  #     appSlug: "stafford.williams/ReactNativePipeline-iOS"
  #     appFile: "output/package/ReactNativePipeline$(Build.BuildNumber).ipa"
  #     symbolsDsymFiles: "output/archive/ReactNativePipeline.xcarchive/dSYMs"
  #     releaseNotesOption: "input"
  #     releaseNotesInput: |
  #       $(Build.SourceVersionMessage)
  #       latest source: '$(Build.SourceVersion)'
  #       An automated release from Azure DevOps
  #     destinationType: "groups"
